<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TrainBot Chat</title>
    <link id="theme-style" rel="stylesheet" href="/static/style-dark.css">
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: white;
        }

        header {
            font-size: 24px;
            font-weight: bold;
            padding: 15px;
            text-align: center;
            background-color: #1f1f1f;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #1f1f1f;
        }

        .left-controls, .right-controls {
            display: flex;
            gap: 10px;
        }

        .top-bar button, .top-bar select {
            padding: 6px 12px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background-color: #333;
            color: white;
        }

        .top-bar button:hover {
            background-color: #444;
        }

        #chatbox {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .user {
            text-align: right;
            margin: 10px;
            color: #4caf50;
        }

        .bot {
            text-align: left;
            margin: 10px;
            color: #03a9f4;
        }

        footer {
            display: flex;
            padding: 10px 20px;
            background-color: #1f1f1f;
        }

        footer input {
            flex: 1;
            padding: 10px;
            font-size: 14px;
            border-radius: 6px;
            border: none;
            margin-right: 10px;
        }

        footer button {
            padding: 10px 16px;
            font-size: 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            background-color: #4caf50;
            color: white;
        }

        footer button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
<header>ðŸš„ TrainBot</header>

<div class="top-bar">
    <div class="left-controls">
        <select id="themeSelector" onchange="setTheme(this.value)">
            <option value="dark" selected>Dark Theme</option>
            <option value="light">Light Theme</option>
        </select>
    </div>
    <div class="right-controls">
        <button id="loginBtn" onclick="window.location.href='/login.html'">Login</button>
        <button id="signupBtn" onclick="window.location.href='/signup.html'">Signup</button>
        <button id="logoutBtn" style="display: none;">Logout</button>
    </div>
</div>

<div id="chatbox"></div>

<footer>
    <input type="text" id="input" placeholder="Ask something..." onkeydown="if(event.key === 'Enter') sendMessage()">
    <button id="sendBtn" onclick="sendMessage()">Send</button>
</footer>

<script>
function sendMessage() {
    const input = document.getElementById("input");
    const message = input.value.trim();
    if (!message) return;

    const chatbox = document.getElementById("chatbox");
    chatbox.innerHTML += `<div class="user">${message}</div>`;
    input.value = "";

    fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: message })
    })
    .then(response => response.json())
    .then(data => {
        const replyHTML = data.reply
            .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>')
            .replace(/\n/g, "<br>");
        chatbox.innerHTML += `<div class="bot">${replyHTML}</div>`;
        chatbox.scrollTop = chatbox.scrollHeight;
    });
}

function setTheme(theme) {
    const themeLink = document.getElementById('theme-style');
    themeLink.setAttribute('href', theme === "light" ? "/static/style-light.css" : "/static/style-dark.css");
    localStorage.setItem("theme", theme);
}

function loadChatHistory() {
    fetch('/chat-history')
        .then(res => res.json())
        .then(history => {
            const chatbox = document.getElementById("chatbox");
            chatbox.innerHTML = ""; // Clear existing messages

            history.forEach(entry => {
                const className = entry.sender_type === 'user' ? 'user' : 'bot';
                const messageHTML = entry.message
                    .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>')
                    .replace(/\n/g, "<br>");
                chatbox.innerHTML += `<div class="${className}">${messageHTML}</div>`;
            });

            chatbox.scrollTop = chatbox.scrollHeight;
        })
        .catch(err => {
            console.error('Failed to load chat history:', err);
        });
}

document.addEventListener("DOMContentLoaded", () => {
    const savedTheme = localStorage.getItem("theme") || "dark";
    setTheme(savedTheme);
    document.getElementById("themeSelector").value = savedTheme;

    fetch('/session-status')
        .then(res => res.json())
        .then(data => {
            const isLoggedIn = data.loggedIn;

            document.getElementById("loginBtn").style.display = isLoggedIn ? "none" : "inline-block";
            document.getElementById("signupBtn").style.display = isLoggedIn ? "none" : "inline-block";
            document.getElementById("logoutBtn").style.display = isLoggedIn ? "inline-block" : "none";

            const input = document.getElementById("input");
            const sendBtn = document.getElementById("sendBtn");
            const chatbox = document.getElementById("chatbox");

            if (!isLoggedIn) {
                input.disabled = true;
                sendBtn.disabled = true;
                chatbox.innerHTML += `<div class="bot">ðŸ”’ Please <a href="/login.html">log in</a> to chat with the bot.</div>`;
            } else {
                input.disabled = false;
                sendBtn.disabled = false;
                loadChatHistory();
            }

            document.getElementById("logoutBtn").addEventListener("click", () => {
                fetch('/logout')
                    .then(() => window.location.reload());
            });
        });
});
</script>
</body>
</html>
